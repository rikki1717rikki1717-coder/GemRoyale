<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gem Royale - Red Edition</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=M+PLUS+Rounded+1c:wght@500;800&family=Rubik:wght@600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Â§âÊõ¥: Ëµ§„ÇíÂü∫Ë™ø„Å®„Åó„Åü„Ç¢„ÇØ„Çª„É≥„Éà */
            --primary: #D32F2F;
            --primary-light: #FF5252;
            --primary-dark: #B71C1C;
            --accent: #FFC107; /* ÈªÑËâ≤„ÅØ„Çµ„Éñ */
            
            --font-title: 'Luckiest Guy', cursive;
            --font-ui: 'Rubik', sans-serif;
            --font-jp: 'M PLUS Rounded 1c', sans-serif;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }

        body {
            margin: 0;
            background-color: #000;
            overflow: hidden;
            font-family: var(--font-jp);
            color: white;
            height: 100vh;
            width: 100vw;
        }

        canvas { display: block; width: 100%; height: 100%; }

        /* --- „Ç™„Éº„Éê„Éº„É¨„Ç§ --- */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            /* ËÉåÊôØ: Ëµ§„Å®Èªí„ÅÆ„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥ */
            background: radial-gradient(circle, #4a1a1c 0%, #1a0505 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; transition: all 0.3s ease;
        }
        .overlay::before {
            content: ''; position: absolute; top:0; left:0; width:100%; height:100%;
            background-image: repeating-linear-gradient(45deg, rgba(0,0,0,0.2) 0px, rgba(0,0,0,0.2) 20px, transparent 20px, transparent 40px);
            pointer-events: none;
        }
        .hidden { opacity: 0; pointer-events: none; }

        h1 {
            font-family: var(--font-title);
            font-size: 5rem;
            color: #FF5252;
            -webkit-text-stroke: 4px #000;
            text-shadow: 5px 5px 0 #000;
            transform: rotate(-3deg);
            margin-bottom: 10px;
            letter-spacing: 3px;
            z-index: 10;
        }

        /* --- „Ç≠„É£„É©ÈÅ∏Êäû & „Çπ„ÉÜ„Éº„Çø„Çπ --- */
        .char-selection-wrapper {
            display: flex; gap: 40px; align-items: flex-start; z-index: 10;
            margin-bottom: 30px;
        }

        .card-container { display: flex; gap: 15px; }

        .char-card {
            background: #263238; border: 4px solid #455A64; border-radius: 15px;
            padding: 10px; width: 110px; text-align: center; cursor: pointer; transition: 0.2s;
        }
        .char-card.selected {
            background: #fff; border-color: var(--primary); transform: translateY(-10px) scale(1.1);
            box-shadow: 0 0 20px var(--primary);
        }
        .char-card.selected .char-name { color: #000; }
        .char-icon { font-size: 3rem; }
        .char-name { font-family: var(--font-ui); font-weight: 800; font-size: 0.9rem; color: #fff; margin-top:5px; }

        /* „Çπ„ÉÜ„Éº„Çø„ÇπË©≥Á¥∞ */
        .stats-panel {
            background: rgba(0,0,0,0.6); border: 2px solid #555; border-radius: 15px;
            padding: 20px; width: 220px;
            backdrop-filter: blur(5px);
        }
        .stat-row { margin-bottom: 10px; }
        .stat-label { font-size: 0.8rem; color: #ccc; margin-bottom: 3px; display:flex; justify-content:space-between;}
        .stat-bar-bg { width: 100%; height: 8px; background: #333; border-radius: 4px; overflow: hidden; }
        .stat-bar-fill { height: 100%; background: var(--primary-light); width: 0%; transition: width 0.3s; }

        /* „Éú„Çø„É≥ (Ëµ§) */
        .btn-start {
            font-family: var(--font-title);
            font-size: 2.5rem;
            background: linear-gradient(to bottom, #FF5252, #D32F2F);
            color: #fff;
            border: 4px solid #fff;
            padding: 15px 80px;
            border-radius: 15px;
            cursor: pointer;
            box-shadow: 0 8px 0 #8b0000, 0 20px 20px rgba(0,0,0,0.5);
            text-shadow: 2px 2px 0 #000;
            text-transform: uppercase;
            z-index: 10;
            transition: 0.1s;
        }
        .btn-start:active { transform: translateY(6px); box-shadow: 0 2px 0 #8b0000; }

        /* --- HUD --- */
        #hud { pointer-events: none; }
        .score-board {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            display: flex; align-items: center; justify-content: space-between;
            width: 320px; height: 60px;
            background: rgba(0,0,0,0.6); border-radius: 30px; padding: 0 15px;
            border: 3px solid rgba(255,255,255,0.3);
        }
        .team-score { font-family: var(--font-title); font-size: 2.2rem; display: flex; align-items: center; gap: 10px; -webkit-text-stroke: 1.5px black; }
        .score-blue { color: #40C4FF; } .score-red { color: #FF4081; flex-direction: row-reverse; }

        /* „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥ */
        #countdown-container {
            position: absolute; top: 15%; width: 100%; text-align: center; display: none;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        .cd-title { font-family: var(--font-jp); font-weight: 800; font-size: 1.5rem; color: #fff; text-shadow: 2px 2px 0 #000; }
        .cd-number { font-family: var(--font-title); font-size: 7rem; -webkit-text-stroke: 3px black; animation: pulse 1s infinite; }
        .cd-blue { color: #40C4FF; } .cd-red { color: #FF4081; }

        /* „É™„Ç∂„É´„Éà */
        .result-header { font-family: var(--font-title); font-size: 5rem; margin: 0; -webkit-text-stroke: 3px black; z-index: 10; }
        .win { color: #00E676; } .lose { color: #FF5252; }
        .stats-table {
            width: 90%; max-width: 600px; margin: 20px 0; z-index: 10;
            background: #fff; border-radius: 10px; overflow: hidden;
            font-family: var(--font-ui); color: #333; border-collapse: collapse;
        }
        .stats-table th { background: #333; color: white; padding: 10px; }
        .stats-table td { padding: 8px; text-align: center; border-bottom: 1px solid #ccc; font-weight: bold; }
        .mvp-row { background-color: #FFF9C4; border: 2px solid #FFC107; }

        /* „Ç≥„É≥„Éà„É≠„Éº„É©„Éº */
        .joystick-zone { position: absolute; bottom: 40px; width: 150px; height: 150px; pointer-events: auto; }
        #stick-left { left: 40px; } #stick-right { right: 40px; }
        .joystick-base { width: 100%; height: 100%; background: rgba(0,0,0,0.2); border: 4px solid rgba(255,255,255,0.4); border-radius: 50%; position: relative; }
        .joystick-handle { width: 60px; height: 60px; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 5px 10px rgba(0,0,0,0.5); background: #fff; }
        #stick-right .joystick-handle { background: #FF5252; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <div id="hud" class="hidden">
        <div class="score-board">
            <div class="team-score score-blue"><span id="score-blue-val">0</span> üíé</div>
            <div class="team-score score-red">üíé <span id="score-red-val">0</span></div>
        </div>
        <div id="countdown-container">
            <div class="cd-title">Âà∂ÂúßÂÆå‰∫Ü„Åæ„Åß</div>
            <div id="countdown-number" class="cd-number">10</div>
        </div>
        <div id="respawn-overlay" class="hidden" style="position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:50;">
            <div style="background:#222; padding:20px; border-radius:15px; border:3px solid #666; text-align:center;">
                <div style="color:#aaa;">RESPAWN IN</div>
                <div id="respawn-timer" style="font-family:var(--font-title); font-size:4rem; color:#FF5252;">3</div>
            </div>
        </div>
        <div id="stick-left" class="joystick-zone"><div class="joystick-base"><div class="joystick-handle"></div></div></div>
        <div id="stick-right" class="joystick-zone"><div class="joystick-base"><div class="joystick-handle"></div></div></div>
    </div>

    <div id="main-menu" class="overlay">
        <h1>GEM BRAWL</h1>
        
        <div class="char-selection-wrapper">
            <div class="card-container">
                <div class="char-card selected" onclick="selectChar('fighter', this)">
                    <div class="char-icon">ü§†</div>
                    <div class="char-name">FIGHTER</div>
                </div>
                <div class="char-card" onclick="selectChar('sniper', this)">
                    <div class="char-icon">üëÆ</div>
                    <div class="char-name">SNIPER</div>
                </div>
                <div class="char-card" onclick="selectChar('tank', this)">
                    <div class="char-icon">ü§º</div>
                    <div class="char-name">TANK</div>
                </div>
            </div>

            <div class="stats-panel">
                <div class="stat-row">
                    <div class="stat-label"><span>HP</span> <span id="stat-hp-val">4400</span></div>
                    <div class="stat-bar-bg"><div id="stat-hp-bar" class="stat-bar-fill" style="width:60%"></div></div>
                </div>
                <div class="stat-row">
                    <div class="stat-label"><span>DAMAGE</span> <span id="stat-atk-val">440</span></div>
                    <div class="stat-bar-bg"><div id="stat-atk-bar" class="stat-bar-fill" style="width:50%"></div></div>
                </div>
                <div class="stat-row">
                    <div class="stat-label"><span>RANGE</span> <span id="stat-rng-val">MED</span></div>
                    <div class="stat-bar-bg"><div id="stat-rng-bar" class="stat-bar-fill" style="width:50%"></div></div>
                </div>
                <div class="stat-row">
                    <div class="stat-label"><span>SPEED</span> <span id="stat-spd-val">FAST</span></div>
                    <div class="stat-bar-bg"><div id="stat-spd-bar" class="stat-bar-fill" style="width:70%"></div></div>
                </div>
            </div>
        </div>

        <button class="btn-start" onclick="startGame()">BATTLE!</button>
    </div>

    <div id="result-screen" class="overlay hidden">
        <h2 id="result-title" class="result-header">VICTORY</h2>
        <table class="stats-table">
            <thead><tr><th>PLAYER</th><th>KILLS</th><th>DEATHS</th><th>GEMS</th></tr></thead>
            <tbody id="stats-body"></tbody>
        </table>
        <button class="btn-start" onclick="resetGame()">AGAIN</button>
    </div>
</div>

<script>
/** ---------------- AUDIO ---------------- */
class AudioManager {
    constructor() { this.ctx = new (window.AudioContext||window.webkitAudioContext)(); }
    resume(){if(this.ctx.state==='suspended')this.ctx.resume();}
    play(t,f,d,v=0.1,s=null){
        const o=this.ctx.createOscillator(),g=this.ctx.createGain();o.type=t;o.frequency.setValueAtTime(f,this.ctx.currentTime);
        if(s)o.frequency.linearRampToValueAtTime(s,this.ctx.currentTime+d);
        g.gain.setValueAtTime(v,this.ctx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,this.ctx.currentTime+d);
        o.connect(g);g.connect(this.ctx.destination);o.start();o.stop(this.ctx.currentTime+d);
    }
    shoot(k){k=='sniper'?this.play('square',600,0.1,0.1,300):k=='tank'?this.play('sawtooth',150,0.2,0.1,50):this.play('triangle',300,0.1,0.1,100);}
    hit(){this.play('sawtooth',100,0.1,0.1);}
    gem(){this.play('sine',1500,0.1,0.1,2000);}
    die(){this.play('triangle',400,0.5,0.2,50);}
}
const Audio = new AudioManager();

/** ---------------- UTILS ---------------- */
const Vector={add:(a,b)=>({x:a.x+b.x,y:a.y+b.y}),sub:(a,b)=>({x:a.x-b.x,y:a.y-b.y}),mult:(a,n)=>({x:a.x*n,y:a.y*n}),mag:a=>Math.sqrt(a.x**2+a.y**2),norm:a=>{let m=Vector.mag(a);return m==0?{x:0,y:0}:{x:a.x/m,y:a.y/m}},dist:(a,b)=>Math.sqrt((a.x-b.x)**2+(a.y-b.y)**2)};
const Rand=(m,M)=>Math.random()*(M-m)+m;

/** ---------------- MAP SYSTEM ---------------- */
const TILE_SIZE = 100;
const MAP_COLS = 20; // 2000px
const MAP_ROWS = 20; // 2000px
// 0:Floor, 1:Wall, 2:Bush, 9:Spawn
// Simple symmetric map generation
const MAP_DATA = [
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,9,0,0,0,0,0,2,2,0,0,2,2,0,0,0,0,0,9,1],
    [1,0,0,0,0,0,0,2,2,0,0,2,2,0,0,0,0,0,0,1],
    [1,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,1],
    [1,0,1,1,0,0,2,2,2,0,0,2,2,2,0,0,1,1,0,1],
    [1,0,0,0,0,0,2,2,2,0,0,2,2,2,0,0,0,0,0,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,2,2,0,0,1,1,0,0,0,0,0,0,1,1,0,0,2,2,1],
    [1,2,2,0,0,1,0,0,0,0,0,0,0,0,1,0,0,2,2,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1], // Center
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1], // Center
    [1,2,2,0,0,1,0,0,0,0,0,0,0,0,1,0,0,2,2,1],
    [1,2,2,0,0,1,1,0,0,0,0,0,0,1,1,0,0,2,2,1],
    [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
    [1,0,0,0,0,0,2,2,2,0,0,2,2,2,0,0,0,0,0,1],
    [1,0,1,1,0,0,2,2,2,0,0,2,2,2,0,0,1,1,0,1],
    [1,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,1],
    [1,0,0,0,0,0,0,2,2,0,0,2,2,0,0,0,0,0,0,1],
    [1,9,0,0,0,0,0,2,2,0,0,2,2,0,0,0,0,0,9,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

function getTile(x, y) {
    let c = Math.floor(x/TILE_SIZE), r = Math.floor(y/TILE_SIZE);
    if(c<0||c>=MAP_COLS||r<0||r>=MAP_ROWS) return 1; // Out of bounds = Wall
    return MAP_DATA[r][c];
}

function checkWall(x, y, radius) {
    // Simple 4-corner check for circle vs grid
    let points = [{x:x-radius,y:y}, {x:x+radius,y:y}, {x:x,y:y-radius}, {x:x,y:y+radius}];
    for(let p of points) {
        if(getTile(p.x, p.y) === 1) return true;
    }
    return false;
}

/** ---------------- CLASSES ---------------- */
class Brawler {
    constructor(x, y, team, type, isBot, name) {
        this.pos={x,y}; this.team=team; this.type=type; this.isBot=isBot; this.name=name;
        this.vel={x:0,y:0}; this.radius=35;
        this.dead=false; this.respawnTime=0; this.lastAction=0;
        this.stats={kills:0,deaths:0,gems:0}; this.gemsHeld=0;
        this.cooldown=0; this.revealTimer=0; // ÊîªÊíÉÊôÇ„ÇÑË¢´ÂºæÊôÇ„Å´Ëçâ„ÇÄ„Çâ„Åß„ÇÇË¶ã„Åà„ÇãÊôÇÈñì

        if(type=='tank'){this.maxHp=6800;this.speed=5;this.range=180;this.dmg=1200;this.reload=45;this.isMelee=true;}
        else if(type=='sniper'){this.maxHp=3200;this.speed=6;this.range=900;this.dmg=950;this.reload=40;this.isMelee=false;}
        else{this.maxHp=4400;this.speed=5.5;this.range=480;this.dmg=440;this.reload=50;this.isMelee=false;}
        this.hp=this.maxHp;
    }

    update() {
        if(this.dead) {
            this.respawnTime--;
            if(this===player) document.getElementById('respawn-timer').innerText = Math.ceil(this.respawnTime/60);
            if(this.respawnTime<=0) this.respawn();
            return;
        }
        if(this.revealTimer>0) this.revealTimer--;

        // Regen
        if(Date.now()-this.lastAction>3000 && this.hp<this.maxHp) {
            this.hp+=this.maxHp*0.005; if(this.hp>this.maxHp)this.hp=this.maxHp;
        }

        // Move + Wall Collision (Simple sliding)
        this.vel = Vector.mult(this.vel, 0.85);
        let nextX = this.pos.x + this.vel.x;
        if(!checkWall(nextX, this.pos.y, this.radius)) this.pos.x = nextX;
        let nextY = this.pos.y + this.vel.y;
        if(!checkWall(this.pos.x, nextY, this.radius)) this.pos.y = nextY;

        if(this.isBot) this.updateAI();
    }

    shoot(aim) {
        if(this.dead||this.cooldown>0)return;
        this.cooldown=this.reload; this.lastAction=Date.now(); this.revealTimer=60; // Reveal
        Audio.shoot(this.type);
        
        let spawnPos = Vector.add(this.pos, Vector.mult(aim, 40)); // Spawn outside body
        
        if(this.isMelee) {
            effects.push(new Effect(this.pos.x+aim.x*50,this.pos.y+aim.y*50,'punch'));
            brawlers.forEach(b=>{
                if(b.team!==this.team&&!b.dead&&Vector.dist(this.pos,b.pos)<this.range) b.hit(this.dmg,this);
            });
        } else {
            const cnt=this.type=='fighter'?3:1, spr=this.type=='fighter'?0.35:0, spd=24;
            let ang=Math.atan2(aim.y,aim.x)-spr/2;
            for(let i=0;i<cnt;i++){
                let a=ang+(cnt>1?(spr/(cnt-1))*i:0);
                bullets.push(new Bullet(spawnPos.x, spawnPos.y, {x:Math.cos(a)*spd,y:Math.sin(a)*spd}, this.dmg, this.team, this.range, this));
            }
        }
    }

    hit(d,atk) {
        if(this.dead)return;
        this.hp-=d; this.lastAction=Date.now(); this.revealTimer=60; Audio.hit();
        effects.push(new TextEffect(Math.floor(d),this.pos.x,this.pos.y-40,'#fff'));
        if(this.hp<=0) {
            this.dead=true; this.respawnTime=180; this.stats.deaths++; if(atk)atk.stats.kills++; Audio.die();
            effects.push(new TextEffect("DOWN!",this.pos.x,this.pos.y,'red'));
            let drop=Math.floor(this.gemsHeld); this.gemsHeld=0;
            for(let i=0;i<drop;i++){
                let a=Math.random()*Math.PI*2, s=Rand(5,15);
                gems.push(new Gem(this.pos.x,this.pos.y,{x:Math.cos(a)*s,y:Math.sin(a)*s}));
            }
            if(this===player)document.getElementById('respawn-overlay').classList.remove('hidden');
        }
    }

    respawn() {
        this.dead=false; this.hp=this.maxHp; this.gemsHeld=0; this.cooldown=0;
        // Spawn points
        let spawns = [];
        for(let r=0; r<MAP_ROWS; r++) {
            for(let c=0; c<MAP_COLS; c++) {
                if(MAP_DATA[r][c] === 9) {
                     // Blue left, Red right
                     if(this.team==='blue' && c < MAP_COLS/2) spawns.push({x:c*TILE_SIZE+50, y:r*TILE_SIZE+50});
                     if(this.team==='red' && c > MAP_COLS/2) spawns.push({x:c*TILE_SIZE+50, y:r*TILE_SIZE+50});
                }
            }
        }
        let s = spawns[Math.floor(Math.random()*spawns.length)];
        this.pos = s ? {x:s.x, y:s.y} : {x:200, y:200};
        
        effects.push(new TextEffect("GO!",this.pos.x,this.pos.y,'#00E676'));
        if(this===player)document.getElementById('respawn-overlay').classList.add('hidden');
    }

    updateAI() {
        let enemies=brawlers.filter(b=>b.team!==this.team&&!b.dead);
        let nearestE=null, minE=9999; enemies.forEach(e=>{let d=Vector.dist(this.pos,e.pos);if(d<minE){minE=d;nearestE=e;}});
        let gemsFound=gems.filter(g=>!g.target);
        let nearestG=null, minG=9999; gemsFound.forEach(g=>{let d=Vector.dist(this.pos,g.pos);if(d<minG){minG=d;nearestG=g;}});

        let move={x:0,y:0}, shootT=null, hpPct=this.hp/this.maxHp;
        
        // --- BUSH LOGIC ---
        let currentTile = getTile(this.pos.x, this.pos.y);
        let inBush = (currentTile === 2);

        // Find nearest Bush
        let nearestBush = null, minBush = 9999;
        if(hpPct < 0.5) {
            for(let r=0;r<MAP_ROWS;r++){
                for(let c=0;c<MAP_COLS;c++){
                    if(MAP_DATA[r][c]===2){
                        let bx=c*TILE_SIZE+50, by=r*TILE_SIZE+50;
                        let d = Vector.dist(this.pos, {x:bx,y:by});
                        if(d<minBush){minBush=d; nearestBush={x:bx,y:by};}
                    }
                }
            }
        }

        if(hpPct<0.3 || (this.gemsHeld>=8 && !inBush)) {
            // Flee to bush or away from enemy
            if(nearestBush && minBush < 800) move=Vector.norm(Vector.sub(nearestBush, this.pos));
            else if(nearestE) move=Vector.norm(Vector.sub(this.pos, nearestE.pos));
            else move=Vector.norm(Vector.sub({x:100,y:900},this.pos));
        }
        else if(nearestG && minG<500) move=Vector.norm(Vector.sub(nearestG.pos, this.pos));
        else if(nearestE) {
            let d=Vector.dist(this.pos,nearestE.pos), opt=this.type=='sniper'?700:(this.type=='tank'?0:300);
            if(d>opt+50) move=Vector.norm(Vector.sub(nearestE.pos,this.pos));
            else if(d<opt-50) move=Vector.norm(Vector.sub(this.pos,nearestE.pos));
            else { let p=Vector.norm(Vector.sub(nearestE.pos,this.pos)); move={x:-p.y,y:p.x}; if(Math.random()<0.02)move=Vector.mult(move,-1); }
            shootT=nearestE;
            // Ambush from bush: Don't shoot if hidden and enemy far
            if(inBush && d > this.range * 0.7) shootT = null; 
        } else move=Vector.norm(Vector.sub({x:1000,y:900},this.pos));

        this.vel=Vector.add(this.vel,Vector.mult(move,0.5));
        if(Vector.mag(this.vel)>this.speed)this.vel=Vector.mult(Vector.norm(this.vel),this.speed);
        
        if(shootT && minE<this.range && Math.random()<0.08) this.shoot(Vector.norm(Vector.sub(shootT.pos,this.pos)));
    }
}

class Bullet {
    constructor(x,y,vel,d,t,r,o){this.pos={x,y};this.vel=vel;this.dmg=d;this.team=t;this.range=r;this.owner=o;this.dist=0;this.dead=false;}
    update(){
        this.pos=Vector.add(this.pos,this.vel); this.dist+=Vector.mag(this.vel);
        if(this.dist>=this.range || checkWall(this.pos.x, this.pos.y, 5)) this.dead=true; // Wall hit
        brawlers.forEach(b=>{
            if(b.team!==this.team&&!b.dead&&Vector.dist(this.pos,b.pos)<b.radius+10){
                b.hit(this.dmg,this.owner); this.dead=true;
                effects.push(new Effect(this.pos.x,this.pos.y,'hit',this.team));
            }
        });
    }
}

class Gem {
    constructor(x,y,v){this.pos={x,y};this.vel=v||{x:0,y:0};this.target=null;this.dead=false;this.floatY=0;}
    update(){
        if(Vector.mag(this.vel)>0.1){
            let next={x:this.pos.x+this.vel.x, y:this.pos.y+this.vel.y};
            if(checkWall(next.x, next.y, 10)) { this.vel.x*=-1; this.vel.y*=-1; } // Bounce
            else { this.pos=next; this.vel=Vector.mult(this.vel,0.9); }
        }
        if(!this.target){
            this.floatY=Math.sin(Date.now()/300)*5;
            brawlers.forEach(b=>{if(!b.dead&&Vector.dist(this.pos,b.pos)<100)this.target=b;});
        }else{
            if(this.target.dead){this.target=null;return;}
            this.pos=Vector.add(this.pos,Vector.mult(Vector.norm(Vector.sub(this.target.pos,this.pos)),25));
            if(Vector.dist(this.pos,this.target.pos)<30){
                this.dead=true;this.target.gemsHeld++;this.target.stats.gems++;Audio.gem();
                effects.push(new TextEffect("+1",this.target.pos.x,this.target.pos.y-60,'#D500F9'));
            }
        }
    }
    draw(ctx){
        ctx.save();ctx.translate(this.pos.x,this.pos.y+(this.target?0:this.floatY));
        ctx.fillStyle='rgba(0,0,0,0.3)';ctx.beginPath();ctx.ellipse(0,15,10,5,0,0,Math.PI*2);ctx.fill();
        ctx.fillStyle='#D500F9';ctx.beginPath();ctx.moveTo(0,-15);ctx.lineTo(15,-4);ctx.lineTo(0,12);ctx.lineTo(-15,-4);ctx.fill();
        ctx.fillStyle='#F3E5F5';ctx.beginPath();ctx.moveTo(0,-15);ctx.lineTo(10,-4);ctx.lineTo(0,0);ctx.lineTo(-10,-4);ctx.fill();
        ctx.restore();
    }
}

class Effect{constructor(x,y,t,c){this.pos={x,y};this.type=t;this.life=15;this.maxLife=15;this.color=c;}update(){this.life--;}draw(ctx){let a=this.life/this.maxLife;if(this.type=='hit'){ctx.fillStyle=this.color=='blue'?'#80D8FF':'#FF8A80';ctx.globalAlpha=a;ctx.beginPath();ctx.arc(this.pos.x,this.pos.y,20*(1-a),0,Math.PI*2);ctx.fill();ctx.globalAlpha=1;}else{ctx.strokeStyle='#fff';ctx.lineWidth=5;ctx.globalAlpha=a;ctx.beginPath();ctx.arc(this.pos.x,this.pos.y,30+20*(1-a),0,Math.PI*2);ctx.stroke();ctx.globalAlpha=1;}}}
class TextEffect{constructor(t,x,y,c){this.text=t;this.pos={x,y};this.color=c;this.life=50;}update(){this.pos.y-=1;this.life--;}draw(ctx){if(this.life<=0)return;ctx.font="900 30px 'Rubik'";ctx.fillStyle=this.color;ctx.strokeStyle='black';ctx.lineWidth=4;ctx.strokeText(this.text,this.pos.x,this.pos.y);ctx.fillText(this.text,this.pos.x,this.pos.y);}}

/** ---------------- MAIN ---------------- */
const cvs=document.getElementById('gameCanvas'), ctx=cvs.getContext('2d');
let gameActive=false,brawlers=[],bullets=[],gems=[],effects=[];
let player,gemTimer=0,cdTime=10,cdActive=false,winTeam=null;
let camera={x:0,y:0}, inputs={move:{x:0,y:0}, aim:{x:0,y:0}}, playerType='fighter';
let floorPatt, wallPatt, bushPatt;

function init(){
    setupJoystick('stick-left','move');setupJoystick('stick-right','aim');resize();
    // Patterns
    let p=c=>document.createElement('canvas').getContext('2d');
    let fp=p();fp.canvas.width=100;fp.canvas.height=100;fp.fillStyle='#2e2e2e';fp.fillRect(0,0,100,100);fp.fillStyle='#333';fp.fillRect(0,0,50,50);fp.fillRect(50,50,50,50);floorPatt=ctx.createPattern(fp.canvas,'repeat');
    let wp=p();wp.canvas.width=50;wp.canvas.height=50;wp.fillStyle='#5D4037';wp.fillRect(0,0,50,50);wp.fillStyle='#4E342E';wp.fillRect(5,5,40,40);wallPatt=ctx.createPattern(wp.canvas,'repeat');
    let bp=p();bp.canvas.width=50;bp.canvas.height=50;bp.fillStyle='#2E7D32';bp.fillRect(0,0,50,50);bp.fillStyle='#388E3C';bp.beginPath();bp.arc(25,25,20,0,Math.PI*2);bp.fill();bushPatt=ctx.createPattern(bp.canvas,'repeat');
    
    // Default stats
    updateStatsUI('fighter');
    loop();
}

function selectChar(t,e){
    document.querySelectorAll('.char-card').forEach(c=>c.classList.remove('selected'));
    e.classList.add('selected'); playerType=t; updateStatsUI(t);
}

function updateStatsUI(t) {
    let stats = {
        fighter: {hp:4400, atk:440, rng:50, spd:70, hpT:'4400', atkT:'440', rngT:'MID', spdT:'NORMAL'},
        sniper: {hp:3200, atk:950, rng:95, spd:85, hpT:'3200', atkT:'950', rngT:'LONG', spdT:'FAST'},
        tank: {hp:6800, atk:1200, rng:20, spd:60, hpT:'6800', atkT:'1200', rngT:'SHORT', spdT:'SLOW'}
    }[t];
    
    document.getElementById('stat-hp-val').innerText = stats.hpT;
    document.getElementById('stat-hp-bar').style.width = (stats.hp/7000*100)+'%';
    document.getElementById('stat-atk-val').innerText = stats.atkT;
    document.getElementById('stat-atk-bar').style.width = (stats.atk/1500*100)+'%';
    document.getElementById('stat-rng-val').innerText = stats.rngT;
    document.getElementById('stat-rng-bar').style.width = stats.rng+'%';
    document.getElementById('stat-spd-val').innerText = stats.spdT;
    document.getElementById('stat-spd-bar').style.width = stats.spd+'%';
}

function startGame(){
    Audio.resume();
    document.getElementById('main-menu').classList.add('hidden');document.getElementById('result-screen').classList.add('hidden');document.getElementById('hud').classList.remove('hidden');
    brawlers=[];bullets=[];gems=[];effects=[];gameActive=true;cdActive=false;cdTime=10;winTeam=null;
    // Spawn
    player=new Brawler(0,0,'blue',playerType,false,"YOU"); player.respawn(); brawlers.push(player);
    let allies=['sniper','tank'], enemies=['fighter','sniper','tank'];
    allies.forEach((t,i)=>{let b=new Brawler(0,0,'blue',t,true,"ALLY "+(i+1));b.respawn();brawlers.push(b);});
    enemies.forEach((t,i)=>{let b=new Brawler(0,0,'red',t,true,"FOE "+(i+1));b.respawn();brawlers.push(b);});
}

function loop(){
    requestAnimationFrame(loop);
    ctx.fillStyle='#000';ctx.fillRect(0,0,cvs.width,cvs.height);
    if(!gameActive)return;

    gemTimer++; if(gemTimer>180 && gems.length<20){gems.push(new Gem(1000+Rand(-150,150),1000+Rand(-150,150)));gemTimer=0;}

    if(Vector.mag(inputs.move)>0.1&&!player.dead){
        player.vel=Vector.add(player.vel,Vector.mult(inputs.move,0.8));
        if(Vector.mag(player.vel)>player.speed)player.vel=Vector.mult(Vector.norm(player.vel),player.speed);
    }

    [...brawlers,...bullets,...gems,...effects].forEach(e=>e.update());
    bullets=bullets.filter(b=>!b.dead);gems=gems.filter(g=>!g.dead);effects=effects.filter(e=>e.life>0);
    camera.x+=(player.pos.x-camera.x)*0.1;camera.y+=(player.pos.y-camera.y)*0.1;

    // Victory Check
    let bS=brawlers.filter(b=>b.team=='blue').reduce((a,c)=>a+c.gemsHeld,0), rS=brawlers.filter(b=>b.team=='red').reduce((a,c)=>a+c.gemsHeld,0);
    document.getElementById('score-blue-val').innerText=bS;document.getElementById('score-red-val').innerText=rS;
    let lead=null; if(bS>=10&&bS>rS)lead='blue';else if(rS>=10&&rS>bS)lead='red';
    let cdEl=document.getElementById('countdown-container'), cdNum=document.getElementById('countdown-number');
    if(lead){
        if(winTeam!==lead){winTeam=lead;cdTime=10;cdEl.style.display='block';cdNum.className=lead=='blue'?'cd-number cd-blue':'cd-number cd-red';cdNum.innerText="10";}
        let old=Math.ceil(cdTime); cdTime-=1/60;
        if(Math.ceil(cdTime)!=old){cdNum.innerText=Math.ceil(cdTime);cdNum.className=lead=='blue'?'cd-number cd-blue':'cd-number cd-red';}
        if(cdTime<=0)endGame(lead);
    }else{winTeam=null;cdEl.style.display='none';}

    // DRAW
    ctx.save(); ctx.translate(cvs.width/2,cvs.height/2); ctx.scale(0.7,0.7); ctx.translate(-camera.x,-camera.y);
    
    // Draw Floor
    ctx.fillStyle=floorPatt; ctx.fillRect(0,0,MAP_COLS*TILE_SIZE, MAP_ROWS*TILE_SIZE);

    // Draw Walls & Bushes (Batching simplified for single pass)
    for(let r=0;r<MAP_ROWS;r++){
        for(let c=0;c<MAP_COLS;c++){
            let t=MAP_DATA[r][c], x=c*TILE_SIZE, y=r*TILE_SIZE;
            if(t===1){ // Wall
                ctx.fillStyle=wallPatt; ctx.fillRect(x,y,TILE_SIZE,TILE_SIZE);
                ctx.fillStyle='rgba(0,0,0,0.3)'; ctx.fillRect(x,y+TILE_SIZE-20,TILE_SIZE,20); // Side
                ctx.strokeStyle='#3E2723'; ctx.lineWidth=4; ctx.strokeRect(x,y,TILE_SIZE,TILE_SIZE);
            }
        }
    }

    // Mine center
    ctx.beginPath(); ctx.arc(1000,1000,120,0,Math.PI*2); ctx.fillStyle='rgba(0,0,0,0.3)'; ctx.fill();
    ctx.strokeStyle='#E040FB'; ctx.lineWidth=5; ctx.setLineDash([15,15]); ctx.stroke(); ctx.setLineDash([]);

    gems.forEach(g=>g.draw(ctx));

    // Brawlers
    brawlers.forEach(b=>{
        if(b.dead)return;
        // Visibility Logic
        let tile = getTile(b.pos.x, b.pos.y);
        let inBush = (tile === 2);
        let visible = true;
        let alpha = 1.0;

        if(inBush) {
            if(b.team === player.team) {
                alpha = 0.5; // Ally in bush
            } else {
                // Enemy in bush
                if(b.revealTimer > 0) visible = true; // Revealed
                else visible = false; // Hidden
            }
        }

        if(visible) {
            ctx.globalAlpha = alpha;
            ctx.fillStyle='rgba(0,0,0,0.4)'; ctx.beginPath(); ctx.ellipse(b.pos.x, b.pos.y+15, 30, 15, 0, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle=b.team=='blue'?'#2979FF':'#FF1744'; ctx.beginPath(); ctx.arc(b.pos.x, b.pos.y, b.radius, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle='#fff'; ctx.lineWidth=4; ctx.stroke();

            // Aim
            if(b===player&&Vector.mag(inputs.aim)>0.1){
                ctx.save();ctx.translate(b.pos.x,b.pos.y);ctx.rotate(Math.atan2(inputs.aim.y,inputs.aim.x));
                ctx.fillStyle='rgba(255,255,255,0.3)';ctx.beginPath();
                if(b.type=='fighter'){ctx.moveTo(0,0);ctx.lineTo(b.range,-60);ctx.lineTo(b.range,60);}else{ctx.fillRect(0,-15,b.range,30);}
                ctx.fill();ctx.restore();
            }
            
            // Bars
            let hpP=b.hp/b.maxHp;
            ctx.fillStyle='#333';ctx.fillRect(b.pos.x-35,b.pos.y-75,70,14);
            ctx.fillStyle=hpP>0.3?'#76FF03':'#FF1744';ctx.fillRect(b.pos.x-35,b.pos.y-75,70*hpP,14);
            ctx.strokeStyle='#000';ctx.lineWidth=2;ctx.strokeRect(b.pos.x-35,b.pos.y-75,70,14);
            ctx.font="bold 10px sans-serif"; ctx.fillStyle="#fff"; ctx.strokeStyle="#000"; ctx.lineWidth=2;
            let hpT=Math.ceil(b.hp)+"/"+b.maxHp; ctx.strokeText(hpT,b.pos.x,b.pos.y-64); ctx.fillText(hpT,b.pos.x,b.pos.y-64);
            
            if(b.reload>0){
                let rP=1-(b.cooldown/b.reload);
                ctx.fillStyle='#333';ctx.fillRect(b.pos.x-35,b.pos.y-58,70,5);
                ctx.fillStyle=rP>=1?'#FF9100':'#aaa';ctx.fillRect(b.pos.x-35,b.pos.y-58,70*rP,5);
            }
            
            ctx.font="800 18px 'M PLUS Rounded 1c'"; ctx.fillStyle='#fff'; ctx.strokeStyle='#000'; ctx.lineWidth=3;
            ctx.strokeText(b.name,b.pos.x,b.pos.y-90); ctx.fillText(b.name,b.pos.x,b.pos.y-90);
            if(b.gemsHeld>0){ctx.font="800 24px 'Luckiest Guy'";ctx.strokeText("üíé"+b.gemsHeld,b.pos.x,b.pos.y-115);ctx.fillText("üíé"+b.gemsHeld,b.pos.x,b.pos.y-115);}
            
            ctx.globalAlpha = 1.0;
        }
    });

    // Draw Bushes (Layer on top of units for hiding effect, but below bullets?)
    // Actually, simple visibility logic is better for 2D. 
    // We'll draw bush TILES transparently on top to indicate "being inside"?
    // For now, let's draw Bush patches on map layer (already done). 
    // But to make it look like they are "in" grass, we can draw grass ON TOP of them if they are in it.
    for(let r=0;r<MAP_ROWS;r++){
        for(let c=0;c<MAP_COLS;c++){
            if(MAP_DATA[r][c]===2){
                let x=c*TILE_SIZE, y=r*TILE_SIZE;
                // Draw grass texture on top with transparency to show they are "wading" through it
                ctx.globalAlpha = 0.6; // See-through grass
                ctx.fillStyle=bushPatt; ctx.fillRect(x,y,TILE_SIZE,TILE_SIZE);
                ctx.globalAlpha = 1.0;
            }
        }
    }

    bullets.forEach(b=>{
        ctx.fillStyle=b.team=='blue'?'#80D8FF':'#FF8A80';ctx.beginPath();ctx.arc(b.pos.x,b.pos.y,12,0,Math.PI*2);ctx.fill();ctx.strokeStyle='#fff';ctx.lineWidth=2;ctx.stroke();
    });
    effects.forEach(e=>e.draw(ctx));
    ctx.restore();
}

function endGame(w){
    gameActive=false;document.getElementById('hud').classList.add('hidden');document.getElementById('result-screen').classList.remove('hidden');
    document.getElementById('result-title').innerText=w=='blue'?"VICTORY!":"DEFEAT";
    document.getElementById('result-title').className=w=='blue'?"result-header win":"result-header lose";
    let tb=document.getElementById('stats-body');tb.innerHTML='';
    let sorted=[...brawlers].sort((a,b)=>(b.stats.kills*2+b.stats.gems)-(a.stats.kills*2+a.stats.gems));
    let mvp=sorted[0];
    ['blue','red'].forEach(tm=>{
        tb.innerHTML+=`<tr><td colspan="4" style="background:${tm=='blue'?'#2979FF':'#FF1744'};color:white;">${tm.toUpperCase()} TEAM</td></tr>`;
        brawlers.filter(b=>b.team==tm).forEach(b=>{
            let tr=document.createElement('tr'); if(b==mvp)tr.className='mvp-row';
            tr.innerHTML=`<td>${b==mvp?"<span style='background:gold;border:1px solid #000;padding:2px;'>MVP</span> ":""}${b.name}</td><td>${b.stats.kills}</td><td>${b.stats.deaths}</td><td>${b.stats.gems}</td>`;
            tb.appendChild(tr);
        });
    });
}

function resetGame(){document.getElementById('result-screen').classList.add('hidden');document.getElementById('main-menu').classList.remove('hidden');}
function setupJoystick(id,t){
    const z=document.getElementById(id),h=z.querySelector('.joystick-handle');let id_=null,o={x:0,y:0};
    const mv=(cx,cy)=>{let dx=cx-o.x,dy=cy-o.y,d=Math.sqrt(dx**2+dy**2),m=60,a=Math.atan2(dy,dx);if(d>m){dx=Math.cos(a)*m;dy=Math.sin(a)*m;}h.style.transform=`translate(calc(-50% + ${dx}px),calc(-50% + ${dy}px))`;let v={x:dx/m,y:dy/m};t=='move'?inputs.move=v:inputs.aim=v;};
    const st=(e)=>{e.preventDefault();let tx=e.changedTouches?e.changedTouches[0]:e;if(e.changedTouches)id_=tx.identifier;let r=z.getBoundingClientRect();o={x:r.left+r.width/2,y:r.top+r.height/2};mv(tx.clientX,tx.clientY);};
    const en=(e)=>{e.preventDefault();id_=null;h.style.transform='translate(-50%,-50%)';t=='move'?inputs.move={x:0,y:0}:(Vector.mag(inputs.aim)>0.2?player.shoot(inputs.aim):null,inputs.aim={x:0,y:0});};
    z.addEventListener('touchstart',st,{passive:false});z.addEventListener('touchmove',e=>{e.preventDefault();let tx=[...e.changedTouches].find(x=>x.identifier==id_);if(tx)mv(tx.clientX,tx.clientY);},{passive:false});z.addEventListener('touchend',en,{passive:false});z.addEventListener('mousedown',st);window.addEventListener('mousemove',e=>{if(id_!==null&&!e.changedTouches)mv(e.clientX,e.clientY);});window.addEventListener('mouseup',e=>{if(id_!==null&&!e.changedTouches)en(e);});
}
function resize(){cvs.width=window.innerWidth;cvs.height=window.innerHeight;}
window.addEventListener('resize',resize);window.onload=init;
</script>
</body>
</html>
