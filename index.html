<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gem Royale - Final</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chango&family=M+PLUS+Rounded+1c:wght@500;800&family=Fredoka:wght@600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #FFC107;
            --blue-team: #2979FF;
            --red-team: #FF1744;
            --font-title: 'Chango', cursive;
            --font-ui: 'Fredoka', sans-serif;
            --font-jp: 'M PLUS Rounded 1c', sans-serif;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }

        body {
            margin: 0;
            background-color: #000;
            overflow: hidden;
            font-family: var(--font-jp);
            color: white;
            height: 100vh;
            width: 100vw;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            background: #1a1a1a;
        }
        canvas { display: block; width: 100%; height: 100%; }

        /* --- ÂÖ±ÈÄö„Ç™„Éº„Éê„Éº„É¨„Ç§ („Ç™„É¨„É≥„Ç∏„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥) --- */
        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            /* Â§âÊõ¥: „Ç™„É¨„É≥„Ç∏„Å®ÈªÑËâ≤„ÅÆ„Ç∞„É©„Éá„Éº„Ç∑„Éß„É≥ */
            background: radial-gradient(circle, #FFC107 0%, #FF9800 40%, #E65100 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: all 0.3s ease;
        }
        /* „Éë„Çø„Éº„É≥„Ç™„Éº„Éê„Éº„É¨„Ç§ */
        .overlay::before {
            content: ''; position: absolute; top:0; left:0; width:100%; height:100%;
            background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.1) 0px, rgba(255,255,255,0.1) 20px, transparent 20px, transparent 40px);
            pointer-events: none;
        }
        .hidden { opacity: 0; pointer-events: none; }

        /* UI „ÉÜ„Ç≠„Çπ„Éà */
        h1 {
            font-family: var(--font-title);
            font-size: 4rem;
            color: #FFF;
            -webkit-text-stroke: 4px #000;
            text-shadow: 0 8px 0 rgba(0,0,0,0.5);
            transform: rotate(-3deg);
            margin-bottom: 20px;
            letter-spacing: 2px;
            z-index: 10;
        }

        /* „Ç≠„É£„É©„ÇØ„Çø„Éº„Ç´„Éº„Éâ */
        .card-container {
            display: flex; gap: 20px; margin-bottom: 40px; flex-wrap: wrap; justify-content: center; z-index: 10;
        }
        .char-card {
            background: linear-gradient(145deg, #424242, #303030);
            border: 4px solid #616161; border-radius: 20px; padding: 15px; width: 140px;
            text-align: center; cursor: pointer; transition: 0.2s; box-shadow: 0 10px 0 #212121;
        }
        .char-card.selected {
            background: #fff; border-color: #333; transform: translateY(-10px) scale(1.05); box-shadow: 0 15px 0 rgba(0,0,0,0.3);
        }
        .char-card.selected .char-name { color: #000; }

        .char-icon { font-size: 3rem; margin-bottom: 5px; }
        .char-name { font-family: var(--font-ui); font-weight: 800; font-size: 1.1rem; color: #fff; }

        /* „Éú„Çø„É≥ */
        .btn-start {
            font-family: var(--font-title);
            font-size: 2.2rem;
            background: #00E676;
            color: #fff;
            border: 4px solid #fff;
            padding: 15px 80px;
            border-radius: 15px;
            cursor: pointer;
            box-shadow: 0 10px 0 #1B5E20, 0 20px 20px rgba(0,0,0,0.3);
            text-shadow: 2px 2px 0 #000;
            text-transform: uppercase;
            z-index: 10;
            transition: 0.1s;
        }
        .btn-start:active { transform: translateY(8px); box-shadow: 0 2px 0 #1B5E20; }

        /* --- HUD --- */
        #hud { pointer-events: none; }
        
        .score-board {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            display: flex; align-items: center; justify-content: space-between;
            width: 320px; height: 60px;
            background: rgba(0,0,0,0.6); border-radius: 30px; padding: 0 15px;
            border: 3px solid rgba(255,255,255,0.3);
        }
        .team-score {
            display: flex; align-items: center; gap: 10px;
            font-family: var(--font-title); font-size: 2rem;
            -webkit-text-stroke: 1.5px black;
        }
        .score-blue { color: #40C4FF; }
        .score-red { color: #FF4081; flex-direction: row-reverse; }

        /* „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥ */
        #countdown-container {
            position: absolute; top: 15%; width: 100%; text-align: center; display: none;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        
        .cd-title { font-family: var(--font-jp); font-weight: 800; font-size: 1.5rem; color: #fff; text-shadow: 2px 2px 0 #000; }
        .cd-number {
            font-family: var(--font-title); font-size: 7rem;
            -webkit-text-stroke: 3px black;
            animation: pulse 1s infinite;
        }
        .cd-blue { color: #40C4FF; text-shadow: 0 0 30px #0277BD; }
        .cd-red { color: #FF4081; text-shadow: 0 0 30px #C2185B; }

        /* „É™„Ç∂„É´„ÉàÁîªÈù¢ */
        .result-header { font-family: var(--font-title); font-size: 5rem; margin: 0; -webkit-text-stroke: 3px black; z-index: 10; }
        .win { color: #00E676; text-shadow: 0 10px 0 rgba(0,0,0,0.3); }
        .lose { color: #FF5252; text-shadow: 0 10px 0 rgba(0,0,0,0.3); }
        
        .stats-table {
            width: 95%; max-width: 700px; margin: 20px 0; z-index: 10;
            background: #fff; border-radius: 15px; overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            font-family: var(--font-ui); color: #333;
            border-collapse: collapse;
        }
        .stats-table th { background: #333; padding: 12px; font-weight: 800; color: #fff; border-bottom: 4px solid #000; }
        .stats-table td { padding: 12px; text-align: center; border-bottom: 2px solid #eee; font-weight: 700; font-size: 1.3rem; }
        
        /* „ÉÅ„Éº„É†„Éò„ÉÉ„ÉÄ„Éº */
        .team-row-header { font-size: 1rem; font-weight: 900; color: white; text-align: left !important; padding: 5px 15px !important; }
        .header-blue { background: #2979FF; }
        .header-red { background: #FF1744; }

        /* MVP Âàó„ÅÆÈáëËâ≤„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes goldShine {
            0% { background-color: #FFF9C4; box-shadow: inset 0 0 10px #FFD54F; }
            50% { background-color: #FFEB3B; box-shadow: inset 0 0 30px #FF6F00; }
            100% { background-color: #FFF9C4; box-shadow: inset 0 0 10px #FFD54F; }
        }
        .mvp-row {
            animation: goldShine 1.5s infinite alternate;
            border: 2px solid #FF6F00;
        }
        .mvp-badge { 
            background: linear-gradient(to bottom, #FFD700, #FFA000); 
            color: #000; border:2px solid #fff; padding: 2px 8px; 
            border-radius: 5px; font-size: 0.9rem; margin-right: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .joystick-zone { position: absolute; bottom: 40px; width: 160px; height: 160px; pointer-events: auto; }
        #stick-left { left: 40px; }
        #stick-right { right: 40px; }
        .joystick-base {
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.2); border: 4px solid rgba(255,255,255,0.4); border-radius: 50%;
            position: relative;
        }
        .joystick-handle {
            width: 60px; height: 60px; border-radius: 50%;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            box-shadow: 0 5px 15px rgba(0,0,0,0.4); background: #fff;
        }
        #stick-right .joystick-handle { background: #FF5252; }

    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <div id="hud" class="hidden">
        <div class="score-board">
            <div class="team-score score-blue"><span id="score-blue-val">0</span> üíé</div>
            <div class="team-score score-red">üíé <span id="score-red-val">0</span></div>
        </div>

        <div id="countdown-container">
            <div class="cd-title">Âà∂ÂúßÂÆå‰∫Ü„Åæ„Åß</div>
            <div id="countdown-number" class="cd-number">10</div>
        </div>

        <div id="respawn-overlay" style="position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:50;" class="hidden">
            <div style="background:#333; padding:20px 40px; border-radius:20px; border:4px solid #888; text-align:center;">
                <div style="color:#ccc; font-size:1.2rem;">Âæ©Ê¥ª„Åæ„Åß</div>
                <div id="respawn-timer" style="font-family:var(--font-title); font-size:4rem; color:#FFC107;">3</div>
            </div>
        </div>

        <div id="stick-left" class="joystick-zone"><div class="joystick-base"><div class="joystick-handle"></div></div></div>
        <div id="stick-right" class="joystick-zone"><div class="joystick-base"><div class="joystick-handle"></div></div></div>
    </div>

    <div id="main-menu" class="overlay">
        <h1>GEM BRAWL</h1>
        <div class="card-container">
            <div class="char-card selected" onclick="selectChar('fighter', this)">
                <div class="char-icon">ü§†</div>
                <div class="char-name">„Éï„Ç°„Ç§„Çø„Éº</div>
            </div>
            <div class="char-card" onclick="selectChar('sniper', this)">
                <div class="char-icon">üëÆ</div>
                <div class="char-name">„Çπ„Éä„Ç§„Éë„Éº</div>
            </div>
            <div class="char-card" onclick="selectChar('tank', this)">
                <div class="char-icon">ü§º</div>
                <div class="char-name">„Çø„É≥„ÇØ</div>
            </div>
        </div>
        <button class="btn-start" onclick="startGame()">BATTLE START</button>
    </div>

    <div id="result-screen" class="overlay hidden">
        <h2 id="result-title" class="result-header">VICTORY!</h2>
        
        <table class="stats-table">
            <thead>
                <tr><th style="text-align:left; padding-left:20px;">PLAYER</th><th>KILLS</th><th>DEATHS</th><th>GEMS</th></tr>
            </thead>
            <tbody id="stats-body"></tbody>
        </table>

        <button class="btn-start" onclick="resetGame()">PLAY AGAIN</button>
    </div>
</div>

<script>
/** ---------------- AUDIO SYSTEM ---------------- */
class AudioManager {
    constructor() { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); }
    resume() { if(this.ctx.state==='suspended') this.ctx.resume(); }
    playTone(f,t,d,v=0.1,s=null) {
        const o=this.ctx.createOscillator(), g=this.ctx.createGain();
        o.type=t; o.frequency.setValueAtTime(f,this.ctx.currentTime);
        if(s) o.frequency.linearRampToValueAtTime(s,this.ctx.currentTime+d);
        g.gain.setValueAtTime(v,this.ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01,this.ctx.currentTime+d);
        o.connect(g); g.connect(this.ctx.destination);
        o.start(); o.stop(this.ctx.currentTime+d);
    }
    shoot(type) { type==='sniper'?this.playTone(600,'square',0.15,0.1,300) : (type==='tank'?this.playTone(150,'sawtooth',0.2,0.15,50) : this.playTone(300,'triangle',0.1,0.1,100)); }
    hit() { this.playTone(100,'sawtooth',0.1,0.1); }
    gem() { this.playTone(1200,'sine',0.15,0.1,1800); setTimeout(()=>this.playTone(1800,'sine',0.2,0.1),100); }
    die() { this.playTone(400,'triangle',0.5,0.3,50); }
    count() { this.playTone(800,'square',0.05,0.1); }
}
const Audio = new AudioManager();

/** ---------------- UTILS ---------------- */
const Vector = {
    add: (v1,v2) => ({x:v1.x+v2.x, y:v1.y+v2.y}),
    sub: (v1,v2) => ({x:v1.x-v2.x, y:v1.y-v2.y}),
    mult: (v,n) => ({x:v.x*n, y:v.y*n}),
    mag: (v) => Math.sqrt(v.x*v.x + v.y*v.y),
    norm: (v) => { let m=Vector.mag(v); return m===0?{x:0,y:0}:{x:v.x/m, y:v.y/m}; },
    dist: (v1,v2) => Math.sqrt((v1.x-v2.x)**2 + (v1.y-v2.y)**2)
};
const Rand = (min,max) => Math.random()*(max-min)+min;

/** ---------------- CONFIG & CLASSES ---------------- */
const CONFIG = {
    w: 1800, h: 1800,
    gemRate: 180, gemPickRadius: 100, gemCollectDist: 20
};

class Brawler {
    constructor(x, y, team, type, isBot, name) {
        this.pos = {x, y};
        this.team = team; this.type = type; this.isBot = isBot; this.name = name;
        this.vel = {x:0, y:0};
        this.radius = 40;
        this.dead = false; this.respawnTime = 0;
        this.lastActionTime = 0;
        this.stats = {kills:0, deaths:0, gems:0};
        this.gemsHeld = 0;
        
        if (type==='tank') { this.hp=6800; this.maxHp=6800; this.speed=5.0; this.range=180; this.dmg=1200; this.reload=45; this.isMelee=true; }
        else if (type==='sniper') { this.hp=3200; this.maxHp=3200; this.speed=6.0; this.range=900; this.dmg=950; this.reload=40; this.isMelee=false; }
        else { this.hp=4400; this.maxHp=4400; this.speed=5.5; this.range=480; this.dmg=440; this.reload=50; this.isMelee=false; }
        this.cooldown = 0;
    }

    update() {
        if(this.dead) {
            this.respawnTime--;
            if(this===player) document.getElementById('respawn-timer').innerText = Math.ceil(this.respawnTime/60);
            if(this.respawnTime<=0) this.respawn();
            return;
        }

        // Regen
        if(Date.now() - this.lastActionTime > 3000 && this.hp < this.maxHp) {
            this.hp += this.maxHp * 0.005;
            if(this.hp > this.maxHp) this.hp = this.maxHp;
        }

        this.vel = Vector.mult(this.vel, 0.85);
        this.pos = Vector.add(this.pos, this.vel);
        if(this.cooldown>0) this.cooldown--;

        this.pos.x = Math.max(this.radius, Math.min(CONFIG.w-this.radius, this.pos.x));
        this.pos.y = Math.max(this.radius, Math.min(CONFIG.h-this.radius, this.pos.y));

        if(this.isBot) this.updateAI();
    }

    shoot(aim) {
        if(this.dead || this.cooldown>0) return;
        this.cooldown = this.reload;
        this.lastActionTime = Date.now();
        Audio.shoot(this.type);

        if(this.isMelee) {
            effects.push(new Effect(this.pos.x+aim.x*50, this.pos.y+aim.y*50, 'punch'));
            brawlers.forEach(b => {
                if(b.team!==this.team && !b.dead && Vector.dist(this.pos, b.pos) < this.range) b.hit(this.dmg, this);
            });
        } else {
            const cnt = this.type==='fighter'?3:1;
            const spr = this.type==='fighter'?0.35:0;
            const spd = 24;
            let ang = Math.atan2(aim.y, aim.x) - spr/2;
            for(let i=0; i<cnt; i++) {
                let a = ang + (cnt>1?(spr/(cnt-1))*i:0);
                bullets.push(new Bullet(this.pos.x, this.pos.y, {x:Math.cos(a)*spd, y:Math.sin(a)*spd}, this.dmg, this.team, this.range, this));
            }
        }
    }

    hit(dmg, attacker) {
        if(this.dead) return;
        this.hp -= dmg;
        this.lastActionTime = Date.now();
        Audio.hit();
        effects.push(new TextEffect(Math.floor(dmg), this.pos.x, this.pos.y-40, '#fff'));
        
        if(this.hp <= 0) {
            this.dead = true; this.respawnTime = 180;
            this.stats.deaths++;
            if(attacker) attacker.stats.kills++;
            Audio.die();
            effects.push(new TextEffect("DOWN!", this.pos.x, this.pos.y, 'red'));
            
            let drop = Math.floor(this.gemsHeld);
            this.gemsHeld = 0;
            for(let i=0; i<drop; i++) {
                let a = Math.random() * Math.PI * 2, s = Rand(5, 15);
                gems.push(new Gem(this.pos.x, this.pos.y, {x:Math.cos(a)*s, y:Math.sin(a)*s}));
            }
            if(this===player) document.getElementById('respawn-overlay').classList.remove('hidden');
        }
    }

    respawn() {
        this.dead = false; this.hp = this.maxHp; this.gemsHeld = 0; this.cooldown = 0;
        this.pos = this.team==='blue' ? {x:200, y:CONFIG.h/2+Rand(-200,200)} : {x:CONFIG.w-200, y:CONFIG.h/2+Rand(-200,200)};
        effects.push(new TextEffect("GO!", this.pos.x, this.pos.y, '#00E676'));
        if(this===player) document.getElementById('respawn-overlay').classList.add('hidden');
    }

    updateAI() {
        let enemies = brawlers.filter(b => b.team !== this.team && !b.dead);
        let nearestEnemy = null, minEDist = 9999;
        enemies.forEach(e => { let d=Vector.dist(this.pos, e.pos); if(d<minEDist){minEDist=d; nearestEnemy=e;} });

        let nearestGem = null, minGDist = 9999;
        gems.filter(g=>!g.target).forEach(g => { let d=Vector.dist(this.pos, g.pos); if(d<minGDist){minGDist=d; nearestGem=g;} });

        let moveDir = {x:0, y:0};
        let shootTarget = null;
        let hpPct = this.hp / this.maxHp;

        if (hpPct < 0.3 || this.gemsHeld >= 8) {
            if (nearestEnemy && minEDist < 600) moveDir = Vector.norm(Vector.sub(this.pos, nearestEnemy.pos));
            else if (hpPct < 0.3) {
                let home = this.team==='blue' ? {x:100, y:CONFIG.h/2} : {x:CONFIG.w-100, y:CONFIG.h/2};
                moveDir = Vector.norm(Vector.sub(home, this.pos));
            }
        } 
        else if (nearestGem && minGDist < 500) moveDir = Vector.norm(Vector.sub(nearestGem.pos, this.pos));
        else if (nearestEnemy) {
            let dist = Vector.dist(this.pos, nearestEnemy.pos);
            let optimalDist = this.type==='sniper' ? 700 : (this.type==='tank' ? 0 : 300);
            if (dist > optimalDist + 50) moveDir = Vector.norm(Vector.sub(nearestEnemy.pos, this.pos));
            else if (dist < optimalDist - 50) moveDir = Vector.norm(Vector.sub(this.pos, nearestEnemy.pos));
            else { let d = Vector.norm(Vector.sub(nearestEnemy.pos, this.pos)); moveDir = {x: -d.y, y: d.x}; if(Math.random()<0.02) moveDir=Vector.mult(moveDir,-1); }
            shootTarget = nearestEnemy;
        } else { moveDir = Vector.norm(Vector.sub({x:CONFIG.w/2, y:CONFIG.h/2}, this.pos)); }

        this.vel = Vector.add(this.vel, Vector.mult(moveDir, 0.5));
        if (Vector.mag(this.vel) > this.speed) this.vel = Vector.mult(Vector.norm(this.vel), this.speed);

        if (shootTarget && minEDist < this.range && Math.random() < 0.08) {
            let predPos = Vector.add(shootTarget.pos, Vector.mult(shootTarget.vel, 5));
            this.shoot(Vector.norm(Vector.sub(predPos, this.pos)));
        }
    }
}

class Bullet {
    constructor(x,y,vel,dmg,team,range,owner) {
        this.pos={x,y}; this.vel=vel; this.dmg=dmg; this.team=team; this.range=range; this.owner=owner;
        this.dist=0; this.dead=false;
    }
    update() {
        this.pos = Vector.add(this.pos, this.vel);
        this.dist += Vector.mag(this.vel);
        if(this.dist >= this.range) this.dead=true;
        brawlers.forEach(b => {
            if(b.team!==this.team && !b.dead && Vector.dist(this.pos, b.pos) < b.radius+10) {
                b.hit(this.dmg, this.owner);
                this.dead=true;
                effects.push(new Effect(this.pos.x, this.pos.y, 'hit', this.team));
            }
        });
    }
}

class Gem {
    constructor(x, y, initVel={x:0, y:0}) {
        this.pos = {x, y}; this.vel = initVel; this.target = null; this.dead = false; this.floatY = 0;
    }
    update() {
        if (Vector.mag(this.vel) > 0.1) {
            this.pos = Vector.add(this.pos, this.vel);
            this.vel = Vector.mult(this.vel, 0.9);
            if(this.pos.x<0 || this.pos.x>CONFIG.w) this.vel.x*=-1;
            if(this.pos.y<0 || this.pos.y>CONFIG.h) this.vel.y*=-1;
        }
        if (!this.target) {
            this.floatY = Math.sin(Date.now()/300)*5;
            brawlers.forEach(b => { if(!b.dead && Vector.dist(this.pos, b.pos) < CONFIG.gemPickRadius) this.target = b; });
        } else {
            if (this.target.dead) { this.target = null; return; }
            let dir = Vector.norm(Vector.sub(this.target.pos, this.pos));
            this.pos = Vector.add(this.pos, Vector.mult(dir, 25));
            if (Vector.dist(this.pos, this.target.pos) < CONFIG.gemCollectDist) {
                this.dead = true; this.target.gemsHeld++; this.target.stats.gems++; Audio.gem();
                effects.push(new TextEffect("+1", this.target.pos.x, this.target.pos.y-60, '#D500F9'));
            }
        }
    }
    draw(ctx) {
        ctx.save(); ctx.translate(this.pos.x, this.pos.y + (this.target?0:this.floatY));
        ctx.fillStyle = 'rgba(0,0,0,0.3)'; ctx.beginPath(); ctx.ellipse(0, 20, 10, 5, 0, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#D500F9'; ctx.beginPath(); ctx.moveTo(0, -20); ctx.lineTo(18, -5); ctx.lineTo(0, 15); ctx.lineTo(-18, -5); ctx.fill();
        ctx.fillStyle = '#F3E5F5'; ctx.beginPath(); ctx.moveTo(0, -20); ctx.lineTo(12, -5); ctx.lineTo(0, 0); ctx.lineTo(-12, -5); ctx.fill();
        ctx.restore();
    }
}

class Effect {
    constructor(x,y,type,color) { this.pos={x,y}; this.type=type; this.life=15; this.maxLife=15; this.color=color; }
    update() { this.life--; }
    draw(ctx) {
        let alpha = this.life/this.maxLife;
        if(this.type==='hit') {
            ctx.fillStyle = this.color==='blue'?'#80D8FF':'#FF8A80'; ctx.globalAlpha = alpha;
            ctx.beginPath(); ctx.arc(this.pos.x, this.pos.y, 20*(1-alpha), 0, Math.PI*2); ctx.fill(); ctx.globalAlpha=1;
        } else if(this.type==='punch') {
            ctx.strokeStyle = '#fff'; ctx.lineWidth=5; ctx.globalAlpha=alpha;
            ctx.beginPath(); ctx.arc(this.pos.x, this.pos.y, 30+20*(1-alpha), 0, Math.PI*2); ctx.stroke(); ctx.globalAlpha=1;
        }
    }
}

class TextEffect {
    constructor(text,x,y,color) { this.text=text; this.pos={x,y}; this.color=color; this.life=50; }
    update() { this.pos.y-=1; this.life--; }
    draw(ctx) {
        if(this.life<=0) return;
        ctx.font = "900 30px 'Fredoka'"; ctx.fillStyle = this.color; ctx.strokeStyle = 'black'; ctx.lineWidth=4;
        ctx.strokeText(this.text, this.pos.x, this.pos.y); ctx.fillText(this.text, this.pos.x, this.pos.y);
    }
}

/** ---------------- MAIN GAME ---------------- */
const cvs = document.getElementById('gameCanvas');
const ctx = cvs.getContext('2d');
let gameActive = false, brawlers=[], bullets=[], gems=[], effects=[];
let player, gemTimer=0, cdTime=10, cdActive=false, winTeam=null;
let camera={x:0,y:0}, inputs={move:{x:0,y:0}, aim:{x:0,y:0}}, playerType='fighter';
let floorPattern;

function init() {
    setupJoystick('stick-left', 'move'); setupJoystick('stick-right', 'aim'); resize();
    let p = document.createElement('canvas'); p.width=100; p.height=100;
    let pc = p.getContext('2d'); pc.fillStyle='#212121'; pc.fillRect(0,0,100,100); pc.fillStyle='#2b2b2b'; pc.fillRect(0,0,50,50); pc.fillRect(50,50,50,50);
    floorPattern = ctx.createPattern(p,'repeat');
    loop();
}

function startGame() {
    Audio.resume();
    document.getElementById('main-menu').classList.add('hidden');
    document.getElementById('result-screen').classList.add('hidden');
    document.getElementById('hud').classList.remove('hidden');
    brawlers=[]; bullets=[]; gems=[]; effects=[];
    gameActive=true; cdActive=false; cdTime=10; winTeam=null;
    
    player = new Brawler(200, CONFIG.h/2, 'blue', playerType, false, "YOU"); brawlers.push(player);
    brawlers.push(new Brawler(200, CONFIG.h/2-300, 'blue', 'sniper', true, "ALLY 1"));
    brawlers.push(new Brawler(200, CONFIG.h/2+300, 'blue', 'tank', true, "ALLY 2"));
    brawlers.push(new Brawler(CONFIG.w-200, CONFIG.h/2, 'red', 'fighter', true, "ENEMY 1"));
    brawlers.push(new Brawler(CONFIG.w-200, CONFIG.h/2-300, 'red', 'sniper', true, "ENEMY 2"));
    brawlers.push(new Brawler(CONFIG.w-200, CONFIG.h/2+300, 'red', 'tank', true, "ENEMY 3"));
}

function loop() {
    requestAnimationFrame(loop);
    ctx.fillStyle = '#000'; ctx.fillRect(0,0,cvs.width,cvs.height);
    if(!gameActive) return;
    
    // Spawning
    gemTimer++;
    if(gemTimer > CONFIG.gemRate && gems.length < 20) {
        gems.push(new Gem(CONFIG.w/2 + Rand(-150,150), CONFIG.h/2 + Rand(-150,150))); gemTimer=0;
    }

    // Move
    if(Vector.mag(inputs.move) > 0.1 && !player.dead) {
        let spd = player.speed;
        player.vel = Vector.add(player.vel, Vector.mult(inputs.move, 0.8));
        if(Vector.mag(player.vel) > spd) player.vel = Vector.mult(Vector.norm(player.vel), spd);
    }
    
    // Update
    [...brawlers, ...bullets, ...gems, ...effects].forEach(e => e.update());
    bullets = bullets.filter(b=>!b.dead); gems = gems.filter(g=>!g.dead); effects = effects.filter(e=>e.life>0);
    camera.x += (player.pos.x - camera.x) * 0.1; camera.y += (player.pos.y - camera.y) * 0.1;

    // Score Logic
    let bScore = brawlers.filter(b=>b.team==='blue').reduce((a,c)=>a+c.gemsHeld,0);
    let rScore = brawlers.filter(b=>b.team==='red').reduce((a,c)=>a+c.gemsHeld,0);
    document.getElementById('score-blue-val').innerText = bScore;
    document.getElementById('score-red-val').innerText = rScore;
    
    let leadTeam = null;
    if(bScore>=10 && bScore>rScore) leadTeam='blue'; else if(rScore>=10 && rScore>bScore) leadTeam='red';
    
    let cdEl = document.getElementById('countdown-container');
    let cdNum = document.getElementById('countdown-number');
    
    if(leadTeam) {
        if(winTeam !== leadTeam) {
            winTeam = leadTeam; cdTime = 10; cdActive = true; cdEl.style.display='block';
            // „Äê‰øÆÊ≠£„Äë„Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥ÈñãÂßãÁõ¥Âæå„Å´„ÇØ„É©„Çπ„ÇíÂç≥Â∫ß„Å´ÈÅ©Áî®
            cdNum.className = leadTeam==='blue' ? 'cd-number cd-blue' : 'cd-number cd-red';
            cdNum.innerText = "10";
        }
        let oldInt = Math.ceil(cdTime);
        cdTime -= 1/60;
        if(Math.ceil(cdTime) !== oldInt) {
            Audio.count();
            cdNum.innerText = Math.ceil(cdTime);
            // Âøµ„ÅÆ„Åü„ÇÅÊØéÁßíÊõ¥Êñ∞
            cdNum.className = leadTeam==='blue' ? 'cd-number cd-blue' : 'cd-number cd-red';
        }
        if(cdTime <= 0) endGame(leadTeam);
    } else {
        winTeam=null; cdActive=false; cdEl.style.display='none';
    }

    // --- DRAW ---
    ctx.save();
    ctx.translate(cvs.width/2, cvs.height/2); ctx.scale(0.7, 0.7); ctx.translate(-camera.x, -camera.y);

    ctx.fillStyle = floorPattern; ctx.fillRect(0,0,CONFIG.w, CONFIG.h);
    ctx.strokeStyle = '#555'; ctx.lineWidth=20; ctx.strokeRect(0,0,CONFIG.w, CONFIG.h);
    ctx.beginPath(); ctx.arc(CONFIG.w/2, CONFIG.h/2, 120, 0, Math.PI*2); ctx.fillStyle='rgba(0,0,0,0.3)'; ctx.fill();
    ctx.strokeStyle='#E040FB'; ctx.lineWidth=5; ctx.setLineDash([15,15]); ctx.stroke(); ctx.setLineDash([]);

    gems.forEach(g => g.draw(ctx));
    
    brawlers.forEach(b => {
        if(b.dead) return;
        ctx.fillStyle='rgba(0,0,0,0.4)'; ctx.beginPath(); ctx.ellipse(b.pos.x, b.pos.y+15, 30, 15, 0, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = b.team==='blue' ? '#2979FF' : '#FF1744';
        ctx.beginPath(); ctx.arc(b.pos.x, b.pos.y, b.radius, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = '#fff'; ctx.lineWidth=4; ctx.stroke();
        
        if(b===player && Vector.mag(inputs.aim)>0.1) {
            ctx.save(); ctx.translate(b.pos.x, b.pos.y); ctx.rotate(Math.atan2(inputs.aim.y, inputs.aim.x));
            ctx.fillStyle='rgba(255,255,255,0.3)'; ctx.beginPath();
            if(b.type==='fighter') { ctx.moveTo(0,0); ctx.lineTo(b.range, -60); ctx.lineTo(b.range, 60); }
            else { ctx.fillRect(0, -15, b.range, 30); }
            ctx.fill(); ctx.restore();
        }

        ctx.textAlign='center';
        // HP Bar
        let hpPct = Math.max(0, b.hp/b.maxHp);
        ctx.fillStyle='#333'; ctx.fillRect(b.pos.x-35, b.pos.y-75, 70, 14);
        ctx.fillStyle=hpPct>0.3?'#76FF03':'#FF1744'; ctx.fillRect(b.pos.x-35, b.pos.y-75, 70*hpPct, 14);
        ctx.strokeStyle='#000'; ctx.lineWidth=2; ctx.strokeRect(b.pos.x-35, b.pos.y-75, 70, 14);
        
        // „Äê‰øÆÊ≠£„ÄëHPÊï∞ÂÄ§„ÅÆË°®Á§∫
        ctx.font = "bold 10px sans-serif";
        ctx.fillStyle = "#fff";
        ctx.strokeStyle = "#000";
        ctx.lineWidth = 2;
        ctx.strokeText(Math.ceil(b.hp) + "/" + b.maxHp, b.pos.x, b.pos.y - 64);
        ctx.fillText(Math.ceil(b.hp) + "/" + b.maxHp, b.pos.x, b.pos.y - 64);

        if(b.reload>0) {
            let rPct = 1 - (b.cooldown/b.reload);
            ctx.fillStyle='#333'; ctx.fillRect(b.pos.x-35, b.pos.y-58, 70, 5);
            ctx.fillStyle=rPct>=1?'#FF9100':'#aaa'; ctx.fillRect(b.pos.x-35, b.pos.y-58, 70*rPct, 5);
        }

        ctx.font="800 18px 'M PLUS Rounded 1c'"; ctx.fillStyle='#fff'; ctx.strokeStyle='#000'; ctx.lineWidth=3;
        ctx.strokeText(b.name, b.pos.x, b.pos.y-90); ctx.fillText(b.name, b.pos.x, b.pos.y-90);
        
        if(b.gemsHeld>0) {
            ctx.font="800 24px 'Fredoka'";
            ctx.strokeText("üíé"+b.gemsHeld, b.pos.x, b.pos.y-115); ctx.fillText("üíé"+b.gemsHeld, b.pos.x, b.pos.y-115);
        }
    });

    bullets.forEach(b => {
        ctx.fillStyle = b.team==='blue'?'#80D8FF':'#FF8A80'; ctx.beginPath(); ctx.arc(b.pos.x, b.pos.y, 12, 0, Math.PI*2); ctx.fill(); ctx.strokeStyle='#fff'; ctx.lineWidth=2; ctx.stroke();
    });
    effects.forEach(e => e.draw(ctx));
    ctx.restore();
}

function endGame(winner) {
    gameActive = false;
    document.getElementById('hud').classList.add('hidden');
    document.getElementById('result-screen').classList.remove('hidden');
    
    let title = document.getElementById('result-title');
    title.innerText = winner==='blue' ? "VICTORY!" : "DEFEAT";
    title.className = winner==='blue' ? "result-header win" : "result-header lose";
    
    let tb = document.getElementById('stats-body'); tb.innerHTML = '';
    
    // Calculate MVP
    let sorted = [...brawlers].sort((a,b) => (b.stats.kills*2 + b.stats.gems) - (a.stats.kills*2 + a.stats.gems));
    let mvp = sorted[0];

    // „Äê‰øÆÊ≠£„Äë„ÉÅ„Éº„É†„Åî„Å®„Å´ÂàÜ„Åë„Å¶Ë°®Á§∫„Åô„ÇãÈñ¢Êï∞
    const renderTeam = (teamName, className, colorHeader) => {
        let teamMembers = brawlers.filter(b => b.team === teamName);
        
        // „Éò„ÉÉ„ÉÄ„ÉºË°å
        let headerRow = document.createElement('tr');
        headerRow.innerHTML = `<td colspan="4" class="team-row-header ${colorHeader}">${teamName.toUpperCase()} TEAM</td>`;
        tb.appendChild(headerRow);

        teamMembers.forEach(b => {
            let tr = document.createElement('tr');
            if(b===mvp) tr.className = 'mvp-row';
            
            let nameHtml = "";
            if(b===mvp) nameHtml += "<span class='mvp-badge'>MVP</span>";
            nameHtml += b.name;
            
            tr.innerHTML = `<td style="text-align:left; padding-left:20px;">${nameHtml}</td><td>${b.stats.kills}</td><td>${b.stats.deaths}</td><td>${b.stats.gems}</td>`;
            tb.appendChild(tr);
        });
    };

    renderTeam('blue', 'row-blue', 'header-blue');
    renderTeam('red', 'row-red', 'header-red');
}

function resetGame() { document.getElementById('result-screen').classList.add('hidden'); document.getElementById('main-menu').classList.remove('hidden'); }
function selectChar(type, el) { document.querySelectorAll('.char-card').forEach(c => c.classList.remove('selected')); el.classList.add('selected'); playerType = type; }
function setupJoystick(id, type) {
    const zone = document.getElementById(id), handle = zone.querySelector('.joystick-handle');
    let tid = null, origin = {x:0,y:0};
    const move = (cx,cy) => {
        let dx=cx-origin.x, dy=cy-origin.y, dist=Math.sqrt(dx*dx+dy*dy), max=60, ang=Math.atan2(dy,dx);
        if(dist>max){dx=Math.cos(ang)*max; dy=Math.sin(ang)*max;}
        handle.style.transform=`translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
        let v={x:dx/max, y:dy/max}; type==='move'?inputs.move=v:inputs.aim=v;
    };
    const start = (e) => { e.preventDefault(); let t=e.changedTouches?e.changedTouches[0]:e; if(e.changedTouches)tid=t.identifier; let r=zone.getBoundingClientRect(); origin={x:r.left+r.width/2, y:r.top+r.height/2}; move(t.clientX, t.clientY); };
    const end = (e) => { e.preventDefault(); tid=null; handle.style.transform='translate(-50%,-50%)'; type==='move'?inputs.move={x:0,y:0}:(Vector.mag(inputs.aim)>0.2?player.shoot(inputs.aim):null, inputs.aim={x:0,y:0}); };
    zone.addEventListener('touchstart', start, {passive:false}); zone.addEventListener('touchmove', e=>{e.preventDefault();let t=[...e.changedTouches].find(x=>x.identifier===tid);if(t)move(t.clientX,t.clientY);}, {passive:false}); zone.addEventListener('touchend', end, {passive:false}); zone.addEventListener('mousedown', start); window.addEventListener('mousemove', e=>{if(tid!==null&&!e.changedTouches)move(e.clientX,e.clientY);}); window.addEventListener('mouseup', e=>{if(tid!==null&&!e.changedTouches)end(e);});
}
function resize() { cvs.width = window.innerWidth; cvs.height = window.innerHeight; }
window.addEventListener('resize', resize); window.onload = init;
</script>
</body>
</html>
